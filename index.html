<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flights Globe</title>
<style>
  html, body { height: 100%; margin: 0; background: #000; color: #eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  #globe { position: fixed; inset: 0; }
  .hud { position: fixed; top: 12px; left: 12px; background: rgba(0,0,0,0.55); padding: 8px 10px; border-radius: 8px; font-size: 13px; }
  .hud b { color: #fff; }
</style>
</head>
<body>
  <div id="globe"></div>
  <div class="hud">
    <div><b>Flights Globe</b></div>
    <div>Hover arcs for details. Data: <code>data.csv</code></div>
  </div>

  <!-- libs via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <script src="./airports.js"></script>

  <script>
    const el = document.getElementById('globe');

    const world = Globe()
      (el)
      .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      // .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .backgroundColor('#000000')
      .arcColor(() => ['#40e0d0', '#d8b4fe'])
      .arcStroke(0.75)
      .arcAltitude(d => d.altitude)
      .arcDashLength(0.25)
      .arcDashGap(0.7)
      .arcDashInitialGap(() => Math.random())
      .arcDashAnimateTime(2000)
      .arcLabel(d => `${d.src.toUpperCase()} → ${d.dest.toUpperCase()} (${d.flightno || '—'})\n${d.dateStr}`)
      .pointAltitude(0.01)
      .pointRadius(0.1)
      .pointColor(() => '#69b3a2')
      .pointLabel(d => `${d.code.toUpperCase()} — ${d.name}`);

    // world.controls().autoRotate = true;
    // world.controls().autoRotateSpeed = 0.45;

    const focus = AIRPORTS.phx;
    world.pointOfView({ lat: focus.lat, lng: focus.lng, altitude: 1.8 }, 0);

    function greatCircleDistance(a, b) {
      const toRad = Math.PI / 180;
      const dLat = (b.lat - a.lat) * toRad;
      const dLon = (b.lng - a.lng) * toRad;
      const lat1 = a.lat * toRad;
      const lat2 = b.lat * toRad;
      const sinDLat = Math.sin(dLat / 2);
      const sinDLon = Math.sin(dLon / 2);
      const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
      return 2 * Math.asin(Math.min(1, Math.sqrt(h))); // radians
    }

    function altitudeFor(a, b) {
      // Scale arc height by distance: 0.06 (short) .. 0.30 (long)
      const d = greatCircleDistance(a, b); // 0..π
      return 0.06 + 0.24 * (d / Math.PI);
    }

    // Load CSV and render
    d3.csv('./data.csv', d => ({
      dateStr: d.date,
      date: d.date ? new Date(d.date) : null,
      src: d.src ? d.src.trim().toLowerCase() : null,
      dest: d.dest ? d.dest.trim().toLowerCase() : null,
      flightno: d.flightno ? d.flightno.trim() : null
    })).then(rows => {
      const flights = rows
        .filter(r => r.src && r.dest && window.AIRPORTS[r.src] && window.AIRPORTS[r.dest])
        .map(r => {
          const a = window.AIRPORTS[r.src];
          const b = window.AIRPORTS[r.dest];
          return {
            ...r,
            startLat: a.lat, startLng: a.lng,
            endLat: b.lat, endLng: b.lng,
            altitude: altitudeFor(a, b)
          };
        });

      const airports = Object.entries(window.AIRPORTS).map(([code, a]) => ({ code, ...a }));

      world
        .arcsData(flights)
        .pointsData(airports);
    }).catch(err => {
      console.error('Failed to load CSV:', err);
    });
  </script>
</body>
</html>

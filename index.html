<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flights Globe</title>
<style>
  html, body { height: 100%; margin: 0; background: #000; color: #eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  #globe { position: fixed; inset: 0; }
  .hud { position: fixed; top: 12px; left: 12px; background: rgba(0,0,0,0.55); padding: 8px 10px; border-radius: 8px; font-size: 13px; }
  .hud b { color: #fff; }
</style>
</head>
<body>
  <div id="globe"></div>
  <div class="hud">
    <div><b>Flights Globe</b></div>
    <div id="stats" style="margin-top:6px; line-height:1.4;"></div>
  </div>

  <!-- libs via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <script src="./airports.js"></script>

  <script>
    const el = document.getElementById('globe');

    const world = Globe()
      (el)
      .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      // .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .backgroundColor('#000000')
      .arcColor(() => ['#40e0d0', '#d8b4fe'])
      .arcStroke(0.75)
      .arcAltitude(d => d.altitude)
      .arcDashLength(0.25)
      .arcDashGap(0.7)
      .arcDashInitialGap(() => Math.random())
      .arcDashAnimateTime(2000)
      .arcLabel(d => `${d.src.toUpperCase()} → ${d.dest.toUpperCase()} (${d.flightno || '—'})\n${d.dateStr}`)
      .pointAltitude(0.01)
      .pointRadius(0.1)
      .pointColor(() => '#69b3a2')
      .pointLabel(d => `${d.code.toUpperCase()} — ${d.name}`);

    // world.controls().autoRotate = true;
    // world.controls().autoRotateSpeed = 0.45;

    const focus = AIRPORTS.phx;
    world.pointOfView({ lat: focus.lat, lng: focus.lng, altitude: 1.8 }, 0);

    function greatCircleDistance(a, b) {
      const toRad = Math.PI / 180;
      const dLat = (b.lat - a.lat) * toRad;
      const dLon = (b.lng - a.lng) * toRad;
      const lat1 = a.lat * toRad;
      const lat2 = b.lat * toRad;
      const sinDLat = Math.sin(dLat / 2);
      const sinDLon = Math.sin(dLon / 2);
      const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
      return 2 * Math.asin(Math.min(1, Math.sqrt(h))); // radians
    }

    function altitudeFor(a, b) {
      // Scale arc height by distance: 0.06 (short) .. 0.30 (long)
      const d = greatCircleDistance(a, b); // 0..π
      return 0.06 + 0.24 * (d / Math.PI);
    }

    const EARTH_RADIUS_KM = 6371;
    const AVERAGE_SPEED_KMH = 900; // rough jet cruise speed for estimate

    function computeStats(flights) {
      const airportCounts = new Map();
      const routeCounts = new Map(); // directionless src-dest

      let totalKm = 0;

      for (const f of flights) {
        // airport visit counts
        airportCounts.set(f.src, (airportCounts.get(f.src) || 0) + 1);
        airportCounts.set(f.dest, (airportCounts.get(f.dest) || 0) + 1);

        // accumulate distance
        totalKm += f.distanceKm || 0;

        // route (directionless)
        const key = [f.src, f.dest].sort().join('-');
        routeCounts.set(key, (routeCounts.get(key) || 0) + 1);
      }

      const totalFlights = flights.length;
      const totalHours = totalKm / AVERAGE_SPEED_KMH;

      const topAirports = Array.from(airportCounts.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([code, count]) => `${code.toUpperCase()} (${count})`);

      let topRoute = null;
      for (const [key, count] of routeCounts.entries()) {
        if (!topRoute || count > topRoute.count) {
          const [a, b] = key.split('-');
          topRoute = { a: a.toUpperCase(), b: b.toUpperCase(), count };
        }
      }

      return { totalFlights, totalHours, topAirports, topRoute };
    }

    function renderStats(stats) {
      const elStats = document.getElementById('stats');
      if (!elStats) return;
      const hours = stats.totalHours.toFixed(1);
      const topAirports = stats.topAirports.join(', ');
      const topRouteStr = stats.topRoute ? `${stats.topRoute.a} ↔ ${stats.topRoute.b} (${stats.topRoute.count})` : '—';
      elStats.innerHTML = `
        <div>Total flights: <b>${stats.totalFlights}</b></div>
        <div>Total hours (est.): <b>${hours}h</b></div>
        <div>Most flown route: <b>${topRouteStr}</b></div>
        <div>Top airports: <b>${topAirports}</b></div>
      `;
    }

    // Load CSV and render
    d3.csv('./data.csv', d => ({
      dateStr: d.date,
      date: d.date ? new Date(d.date) : null,
      src: d.src ? d.src.trim().toLowerCase() : null,
      dest: d.dest ? d.dest.trim().toLowerCase() : null,
      flightno: d.flightno ? d.flightno.trim() : null
    })).then(rows => {
      const flights = rows
        .filter(r => r.src && r.dest && window.AIRPORTS[r.src] && window.AIRPORTS[r.dest])
        .map(r => {
          const a = window.AIRPORTS[r.src];
          const b = window.AIRPORTS[r.dest];
          return {
            ...r,
            startLat: a.lat, startLng: a.lng,
            endLat: b.lat, endLng: b.lng,
            altitude: altitudeFor(a, b),
            distanceKm: greatCircleDistance(a, b) * EARTH_RADIUS_KM
          };
        });

      const airports = Object.entries(window.AIRPORTS).map(([code, a]) => ({ code, ...a }));

      world
        .arcsData(flights)
        .pointsData(airports);

      const stats = computeStats(flights);
      renderStats(stats);
    }).catch(err => {
      console.error('Failed to load CSV:', err);
    });
  </script>
</body>
</html>
